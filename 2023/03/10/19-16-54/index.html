

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Sorcerer Inferior">
  <meta name="keywords" content="">
  
    <meta name="description" content="5级流水线CPU设计文档+中断支持">
<meta property="og:type" content="article">
<meta property="og:title" content="P7设计文档">
<meta property="og:url" content="https://steve-strange.github.io/2023/03/10/19-16-54/index.html">
<meta property="og:site_name" content="TARDIS">
<meta property="og:description" content="5级流水线CPU设计文档+中断支持">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001413097.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001425849.png">
<meta property="og:image" content="https://steve-strange.github.io/image-20230311001016596.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001109169.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001116883.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001122673.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001129478.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001150971.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001621204.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001208043.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001314893.png">
<meta property="og:image" content="https://steve-strange.github.io/image-20230311001726074.png">
<meta property="og:image" content="https://steve-strange.github.io/image-20230311001804942.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001827809.png">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/430ce62ac2101f40f1624ec2b8a9ef6.jpg">
<meta property="og:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/cdf5af3d3ddb8c050cfe8e900e9345d.jpg">
<meta property="og:image" content="https://steve-strange.github.io/87d0c733f6c32a8e759b783e29a9c42.jpg">
<meta property="article:published_time" content="2023-03-10T11:16:54.000Z">
<meta property="article:modified_time" content="2023-03-10T16:32:34.502Z">
<meta property="article:author" content="Sorcerer Inferior">
<meta property="article:tag" content="Computer Orgnization">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://steve-strange.github.io/2023/03/10/19-16-54/image-20230311001413097.png">
  
  
  
  <title>P7设计文档 - TARDIS</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"steve-strange.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="P7设计文档"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-10 19:16" pubdate>
          2023年3月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          115 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">P7设计文档</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="5级流水线CPU设计文档-中断支持"><a href="#5级流水线CPU设计文档-中断支持" class="headerlink" title="5级流水线CPU设计文档+中断支持"></a>5级流水线CPU设计文档+中断支持</h2><span id="more"></span>
<h2 id="支持指令"><a href="#支持指令" class="headerlink" title="支持指令"></a>支持指令</h2><p>  <strong>R, add, sub, And, Or, Xor, slt, sltu</strong></p>
<p>  <strong>addi, andi, xori, ori, lui</strong></p>
<p>  <strong>lb, lh, lw, sb, sh, sw, lbu, lhu</strong></p>
<p>  <strong>mult, multu, div, divu, mfhi, mflo, mthi, mtlo</strong></p>
<p>  <strong>beq, bne, j, jal, jr, bltzal</strong></p>
<p> <strong>nop, eret, mtc0, mfc0, syscall</strong></p>
<h2 id="流程模块设计"><a href="#流程模块设计" class="headerlink" title="流程模块设计"></a>流程模块设计</h2><img src="image-20230311001413097.png" srcset="/img/loading.gif" lazyload alt="image-20230311001413097" style="zoom:67%;" />

<h3 id="CP0"><a href="#CP0" class="headerlink" title="CP0"></a>CP0</h3><ul>
<li>处理来自CPU的内部异常以及来自中断发生器与timer的外部中断，产生异常控制信号给CPU</li>
<li>放置在M级，接收CPU在M级的mtc0,mfc0,eret指令</li>
<li>其中包含三个寄存器SR、Cause、EPC，SR为中断异常使能控制，Cause为异常中断情况，EPC为异常处理结束后需要返回的PC</li>
<li>具体SR、Cause的特定位如下宏定义所示，后续控制逻辑由其产生</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">`define IM SR[15:10]        //Interrupt Mask 由mtc0修改，屏蔽中断<br>`define EXL SR[1]           //Exception Level 表明进入中断异常，禁止所有中断和异常<br>`define IE SR[0]            //Interrupt Enable 全局中断使能(不影响异常)<br>`define BD Cause[31]        //Branch Delay EPC是否指向前一条（延迟槽）指令<br>`define IP Cause[15:10]     //Interrupt Pending 表明6个外部中断有无，由计时器和外部中断修改<br>`define ExcCode Cause[6:2]  //ExcCode 异常编码，记录当前发生的是什么异常。<br></code></pre></td></tr></table></figure>

<ul>
<li><p>通过EXL和ExcCodeIn判断有无异常产生，通过EXL和IE，以及每一位有没有既有中断使能，又有中断信号判断有无中断产生。</p>
</li>
<li><p>注意产生异常或中断时指令在延迟槽，返回PC应为到上一条跳转指令的PC，需要从D级一直流水BDIn信号，tmp_EPC &#x3D; Req?(BDIn?VPC-4:VPC):EPC</p>
</li>
<li><p>其中VPC为M级PC，即在外界观察到的宏观PC</p>
</li>
<li><p>写寄存器只可写SR以及EPC，判断写入地址是否是12或14并且有写使能</p>
</li>
<li><p>读寄存器可以直接读，根据地址12 13 14读三个寄存器</p>
</li>
<li><p>端口</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>en</td>
<td>input</td>
<td></td>
<td>写使能信号 (mtc0)</td>
</tr>
<tr>
<td>CP0Add</td>
<td>input</td>
<td>[4:0]</td>
<td>读写寄存器的编号</td>
</tr>
<tr>
<td>CP0In</td>
<td>input</td>
<td>[31:0]</td>
<td>CP0写入数据</td>
</tr>
<tr>
<td>CP0Out</td>
<td>output</td>
<td>[31:0]</td>
<td>CP0读出数据</td>
</tr>
<tr>
<td>VPC</td>
<td>input</td>
<td>[31:0]</td>
<td>受害PC</td>
</tr>
<tr>
<td>BDIn</td>
<td>input</td>
<td></td>
<td>是否是延迟槽指令</td>
</tr>
<tr>
<td>EPCOUt</td>
<td>output</td>
<td>[31:0]</td>
<td>EPC的值</td>
</tr>
<tr>
<td>EXLClr</td>
<td>input</td>
<td></td>
<td>用来复位EXL（M级指令是eret，即退出异常）</td>
</tr>
<tr>
<td>ExcCodeIn</td>
<td>input</td>
<td>[4:0]</td>
<td>记录异常类型</td>
</tr>
<tr>
<td>HWInt</td>
<td>input</td>
<td>[5:0]</td>
<td>输入6个设备中断信号</td>
</tr>
<tr>
<td>Req</td>
<td>output</td>
<td></td>
<td>进入处理程序请求（有异常或中断）</td>
</tr>
</tbody></table>
<h3 id="系统桥"><a href="#系统桥" class="headerlink" title="系统桥"></a>系统桥</h3><ul>
<li>对CPU向外设写入的数据进行分流，对外设向CPU写入的数据进行选择。</li>
</ul>
<img src="image-20230311001425849.png" srcset="/img/loading.gif" lazyload alt="image-20230311001425849" width="67%" height="67%" />

<ul>
<li>CPU从外设读：根据地址用MUX筛选；CPU向外设写：写地址、数据直接全部发送，写使能用byteen以及写地址决定决定</li>
<li>修改层级结构，在最高层通过系统桥将CPU与外置DM,TC0,TC1,以及中断生成器相连</li>
<li>注意传给DM的按位读写使能要再读写其他外设时置为0</li>
<li>端口：</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>CPUAddr</td>
<td>input</td>
<td>[31:0]</td>
<td>CPU读写地址</td>
</tr>
<tr>
<td>CPUWD</td>
<td>input</td>
<td>[31:0]</td>
<td>CPU往外设写数据</td>
</tr>
<tr>
<td>CPUbyteen</td>
<td>input</td>
<td>[3:0]</td>
<td>按位读写使能</td>
</tr>
<tr>
<td>TC0Write</td>
<td>output</td>
<td></td>
<td>写TC0</td>
</tr>
<tr>
<td>TC1Write</td>
<td>output</td>
<td></td>
<td>写TC1</td>
</tr>
<tr>
<td>DEV_Addr</td>
<td>output</td>
<td>[31:0]</td>
<td>往外设写入的地址</td>
</tr>
<tr>
<td>DEV_WD</td>
<td>output</td>
<td>[31:0]</td>
<td>往外设写入的数据</td>
</tr>
<tr>
<td>temp_m_data_byteen</td>
<td>output</td>
<td>[3:0]</td>
<td>传给DM的按位读写使能</td>
</tr>
<tr>
<td>DMRD</td>
<td>input</td>
<td>[31:0]</td>
<td>三个外设写入CPU的数据</td>
</tr>
<tr>
<td>TC0RD</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>TC1RD</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>CPURD</td>
<td>output</td>
<td>[31:0]</td>
<td>最后决定写入CPU的数据</td>
</tr>
</tbody></table>
<h3 id="TC"><a href="#TC" class="headerlink" title="TC"></a>TC</h3><ul>
<li><p>包含三个32位寄存器，ctrl, preset, count</p>
</li>
<li><p>ctrl[3]表示中断屏蔽（1允许中断），[2:1]为模式选择，[0]为计数器使能</p>
</li>
<li><p>四个状态的状态机，在INT状态下，如果中断没有屏蔽，则向外发送中断信号</p>
<ul>
<li>idle状态下，如果计数器使能为1则转至load状态</li>
<li>load状态下，加载初始值之后转至cnt状态</li>
<li>cnt状态下，如计数器使能为1则开始倒计数，cnt&#x3D;&#x3D;0之后产生一周期终端信号，状态变为interrupt；如果计数器使能为0，则回到idle</li>
<li>interrupt状态下，如果在模式0，计数到0时计数器使能变0；如果在模式1，计数为0时中断变0。之后回到idle，等待计数器使能变1往复</li>
</ul>
</li>
<li><p>端口</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Addr</td>
<td>input</td>
<td>[31:2]</td>
<td></td>
</tr>
<tr>
<td>WE</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Din</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>Dout</td>
<td>output</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>IRQ</td>
<td>output</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="内部异常设计"><a href="#内部异常设计" class="headerlink" title="内部异常设计"></a>内部异常设计</h3><ul>
<li><p>所有异常级别低于中断级别，并均低于Reset</p>
</li>
<li><p>每一级的异常流水需要遵循距离M级远的优先级更高，即在上一级有异常时，按上一级往后传；没有异常时，再判断当前阶段有无异常。</p>
</li>
<li><p>F级有F_Exc_AdEL，取指令异常，即取地址低位没有对齐或者超出地址存储区域。注意在有eret信号时，直接跳转到中断处理程序，不产生异常。</p>
</li>
<li><p>D级D_Exc_RI，即未知指令与D_Exc_syscall，即syscall指令，从CU增加两个控制信号即可。</p>
</li>
<li><p>E级有E_Exc_AriOv，即计算指令溢出。同时还可产生E_Exc_DMOv，即地址指令溢出，但需要注意该异常需要在M级才真正出现，E级只是提前计算，访存指令还未执行，需要跳过E级异常流水，直接传给M级再加入异常流水判断。</p>
</li>
<li><p>M级有M_Exc_AdES与M_Exc_AdEL，即写入地址错误与读出地址错误。注意除了地址不对齐、超出范围之外，还有M级的地址运算溢出，<strong>以及不可用lb,lh读写timer中三个寄存器和不可写timer中count寄存器的要求</strong>。</p>
</li>
<li><p>最后传至CP0的即M级的ExcCode</p>
</li>
</ul>
<h3 id="CU模块设计"><a href="#CU模块设计" class="headerlink" title="CU模块设计"></a>CU模块设计</h3><ul>
<li>相较P4，省去RegWrite信号，直接译出当前指令需要写入的地址，如不需写入，默认写至0，在写入GRF时直接略去</li>
<li>直接译出当前指令rs, rt, rd, shamt, imm16, imm26以及所有控制信号供每个阶段选取使用，还需译出Tuse_rs&#x2F;rt以及E_Tnew与M_Tnew，各级输出对应信号至Conflict模块</li>
<li>将指令分类，分为：cal_r,cal_i,md,mt,mf,load,save,branch,branch_ucl,branch_cl,shift,jreg,jadd,jlink（ori被归为cal_i）</li>
<li>增加四个指令，增加GRF写入数据来源、写入地址的选择</li>
<li>增加ALUDM、ALUAri输出端口，表示当前使用ALU计算的指令是地址访存指令还是计算指令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs assembly">   assign cal_r=(add||sub||And||Or||Xor||slt||sltu);<br>assign cal_i=(addi||andi||xori||ori||lui);<br><br>   assign md   =(mult||multu||div||divu);<br>   assign mf   =(mfhi||mflo);<br>   assign mt   =(mthi||mtlo);<br><br>assign load=(lw||lh||lhu||lb||lbu);<br>assign save=(sw||sh||sb);<br><br>   assign branch=(beq||bne||branch_ucl||branch_cl);<br>   assign branch_ucl=bltzal;<br>   assign branch_cl=0;<br><br>   assign jreg = jr;<br>   assign jadd = (j||jal);<br>   assign jlink = jal;<br><br>   assign shift=sll;<br></code></pre></td></tr></table></figure>

<ul>
<li>控制信号新增：MDU, MDUStart, MDUSelect, MFSelect, ByteSelect, DESelect</li>
<li>控制信号调整：GRF_WA, GRF_WDSrc, ALUSelect, <strong>EXTSelect（cal_i各个指令行为不同，注意对照指令集）</strong>,BranchSelect</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Ins</td>
<td>input</td>
<td>[31:0]</td>
<td>当级指令</td>
</tr>
<tr>
<td>branchTrue</td>
<td>input</td>
<td></td>
<td>分支控制信号</td>
</tr>
<tr>
<td><strong>控制信号</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GRF_WA</td>
<td>output</td>
<td>[4:0]</td>
<td>写入的地址</td>
</tr>
<tr>
<td>GRF_WDSrc</td>
<td>output</td>
<td>[2:0]</td>
<td>写入数据选择</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EXTSelect</td>
<td>output</td>
<td></td>
<td>EXT位拓展类型选择</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ALUSrc</td>
<td>output</td>
<td></td>
<td>ALU_B的数据源选择</td>
</tr>
<tr>
<td>ALUSelect</td>
<td>output</td>
<td>[3:0]</td>
<td>ALU运算类型选择</td>
</tr>
<tr>
<td><u>MDU</u></td>
<td>output</td>
<td></td>
<td>乘除运算+读写HI LO信号（需要阻塞）</td>
</tr>
<tr>
<td><u>MDUStart</u></td>
<td>output</td>
<td></td>
<td>乘除运算开始信号</td>
</tr>
<tr>
<td><u>MDUSelect</u></td>
<td>output</td>
<td>[2:0]</td>
<td>乘除运算+写HI LO功能选择</td>
</tr>
<tr>
<td><u>MFSelect</u></td>
<td>output</td>
<td>[1:0]</td>
<td>读HI LO功能选择</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MemWrite</td>
<td>output</td>
<td></td>
<td>内存写入控制</td>
</tr>
<tr>
<td>BranchSelect</td>
<td>output</td>
<td>[3:0]</td>
<td>branch判断类型选择</td>
</tr>
<tr>
<td>NPCSelect</td>
<td>output</td>
<td>[2:0]</td>
<td>NPC类型选择</td>
</tr>
<tr>
<td><u>ByteSelect</u></td>
<td>output</td>
<td>[1:0]</td>
<td>访存数据类型选择</td>
</tr>
<tr>
<td><u>DESelect</u></td>
<td>output</td>
<td>[2:0]</td>
<td>读取内存后结果拓展类型</td>
</tr>
<tr>
<td><strong>指令译码</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>opcode</td>
<td>output</td>
<td>[5:0]</td>
<td></td>
</tr>
<tr>
<td>funct</td>
<td>output</td>
<td>[5:0]</td>
<td></td>
</tr>
<tr>
<td>rs</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>rt</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>rd</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>shamt</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>imm16</td>
<td>output</td>
<td>[15:0]</td>
<td></td>
</tr>
<tr>
<td>imm26</td>
<td>output</td>
<td>[25:0]</td>
<td></td>
</tr>
<tr>
<td><strong>T计算</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Tuse_rs</td>
<td>output</td>
<td>[1:0]</td>
<td></td>
</tr>
<tr>
<td>Tuse_rt</td>
<td>output</td>
<td>[1:0]</td>
<td></td>
</tr>
<tr>
<td>E_Tnew</td>
<td>output</td>
<td>[1:0]</td>
<td></td>
</tr>
<tr>
<td>M_Tnew</td>
<td>output</td>
<td>[1:0]</td>
<td></td>
</tr>
</tbody></table>
<h4 id="T计算表格"><a href="#T计算表格" class="headerlink" title="T计算表格"></a>T计算表格</h4><ul>
<li>注意新增的乘除指令的AT</li>
</ul>
<table>
<thead>
<tr>
<th>Ins</th>
<th>Tuse_rs</th>
<th>Tuse_rt</th>
<th>E_Tnew</th>
<th>M_Tnew</th>
</tr>
</thead>
<tbody><tr>
<td>cal_r</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>cal_i</td>
<td>1</td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td><u>md</u></td>
<td>1</td>
<td>1</td>
<td></td>
<td></td>
</tr>
<tr>
<td><u>mt</u></td>
<td>1</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><u>mf</u></td>
<td></td>
<td></td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>load</td>
<td>2</td>
<td></td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>save</td>
<td>1</td>
<td>2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>branch</td>
<td>0</td>
<td>0</td>
<td></td>
<td></td>
</tr>
<tr>
<td>jreg</td>
<td>0</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Conflit模块设计：AT控制阻塞，直接转发"><a href="#Conflit模块设计：AT控制阻塞，直接转发" class="headerlink" title="Conflit模块设计：AT控制阻塞，直接转发"></a>Conflit模块设计：AT控制阻塞，直接转发</h3><h4 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h4><ul>
<li>D级判断将要使用的寄存器数据是否能得到转发更新，即后续写入相同寄存器的Tnew是否有大于Tuse的，如果有则需要阻塞，以在后续能得到转发更新。特判0号寄存器不需要阻塞，能够直接获得数据0</li>
<li>需要得到D级指令rs, rt的Tuse，以及后续E, M级指令的Tnew，在各级CU中计算，发送至冲突单元（W级Tnew全是0不需要考虑，都可以内部转发解决）</li>
<li>阻塞时需要暂停更新PC以及F级读出的指令，并且清空D级当前指令的译码输出，以替换为nop空泡</li>
<li>P6新增乘除Stall，在乘除运算即将开始或正在进行时如遇到乘除指令需要Stall</li>
<li>P7新增eret的Stall，eret与mtc0的写后读冲突，需要单独判断阻塞，判断方法为当D级为eret即将读CP0的EPC时，EM级如果有mtc0即将写入CP0的EPC，即rd为14时，阻塞。</li>
</ul>
<p><img src="/image-20230311001016596.png" srcset="/img/loading.gif" lazyload alt="image-20230311001016596"></p>
<h4 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h4><ul>
<li><p>阻塞后，所有指令在需要读寄存器数据的时候都能够获得后续计算完毕的数据，每级转发出已算出的数据，发送给之前各级即可。</p>
</li>
<li><p>需要读寄存器：D级GRF，Branch计算需要rs, rt数据；E级ALU需要rs,rt 数据；M级DM写入数据口需要rt数据</p>
</li>
<li><p>需要写寄存器：E级可转发出D级算的PC+8；M级可转发出D级算的PC+8和E级算的的ALU_Y；W级可转发出D级算的PC+8，E级算的的ALU_Y和M级读出的DM数据。<strong>根据当前指令CU译码得到的GRF_WDSrc进行选择</strong>。此外还有W级寄存器写入，可直接内部转发至D级读出</p>
</li>
</ul>
<img src="image-20230311001109169.png" srcset="/img/loading.gif" lazyload alt="image-20230311001109169" style="zoom:67%;" />

<img src="image-20230311001116883.png" srcset="/img/loading.gif" lazyload alt="image-20230311001116883" style="zoom:67%;" />

<img src="image-20230311001122673.png" srcset="/img/loading.gif" lazyload alt="image-20230311001122673" style="zoom:67%;" />

<img src="image-20230311001129478.png" srcset="/img/loading.gif" lazyload alt="image-20230311001129478" style="zoom:67%;" />

<ul>
<li>在主模块中，获取各级需要读的寄存器编号（D_rs,D_rt,E_rs,E_rt,M_rt），寄存器原读数（D_rs_data,D_rt_data,E_rs_data,E_rt_data,M_rt_data），写入的寄存器编号（E_GRF_WA,M_GRF_WA,W_GRF_WA）和数据（E_GRF_WD,M_GRF_WD,W_GRF_WD）</li>
<li>比较读的编号和写的编号是否有相等的，如有相等的则代表有数据已经更新需要转发，转发优先级为更新次序，最后一次更新优先转发，即优先转发距离需要数据的阶段近的数据，特判如果需要读0号寄存器的数据，直接转发0</li>
<li>转发的数据（D_rs_fw,D_rt_fw,E_rs_fw,E_rt_fw,M_rt_fw）发送至各级需要的部分运算，并传递给下一级</li>
</ul>
<img src="image-20230311001150971.png" srcset="/img/loading.gif" lazyload alt="image-20230311001150971" style="zoom: 67%;" />

<h3 id="五级模块设计"><a href="#五级模块设计" class="headerlink" title="五级模块设计"></a>五级模块设计</h3><img src="image-20230311001621204.png" srcset="/img/loading.gif" lazyload alt="image-20230311001621204" style="zoom:80%;" />

<ul>
<li><p>每个阶段之间以寄存器隔开，寄存器设计在每个模块输出处，使用reg类型</p>
</li>
<li><p>每个阶段之间需要流水传递Ins，PC，传给各级CU以译码出当前阶段的rs，rt以及需要写入的地址和写入数据的选择</p>
</li>
<li><p>部分阶段前后间需要传递需要使用的NPC, EXTout, ALU_Y, DM_RD</p>
</li>
<li><p>P7新增：各级传出ExcCode并流水传递以及DS（指令是否在延迟槽中）；CU需在D和M级多译出rd，为对CP0的读写提供阻塞条件与地址</p>
</li>
</ul>
<h4 id="P6更新乘除槽与储存器外置以及按字节访存"><a href="#P6更新乘除槽与储存器外置以及按字节访存" class="headerlink" title="P6更新乘除槽与储存器外置以及按字节访存"></a>P6更新乘除槽与储存器外置以及按字节访存</h4><ul>
<li>删去F_IFU与M_DM，添加M_DE与E_MDU</li>
<li>乘除槽有两个寄存器，其中数据需要在EMW级流水，以便进行转发，并且需要添加转发信号控制</li>
<li>外置储存器需要修改数据通路，前寄存器发送写入数据，后寄存器接收读出数据</li>
</ul>
<h4 id="P7宏观PC"><a href="#P7宏观PC" class="headerlink" title="P7宏观PC"></a>P7宏观PC</h4><ul>
<li><p>在外界的视角，仅需知道当前周期的情况，外界通过给出中断与CPU沟通，中断处理器位于M级，所以M级表现在外，宏观PC为M级PC</p>
</li>
<li><p>为了保证做出单周期的表现，需要在出现异常中断时，所有流水寄存器统一做出跳转到4180中断处理程序的形态，并停止流水线中所有正在执行的指令的行为</p>
</li>
</ul>
<h4 id="1-Fetch"><a href="#1-Fetch" class="headerlink" title="1. Fetch"></a>1. Fetch</h4><ul>
<li>包含FDReg</li>
<li>Fetch</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>F_Flush</td>
<td>input</td>
<td></td>
<td>清空延迟槽信号</td>
</tr>
<tr>
<td>F_Stall</td>
<td>input</td>
<td></td>
<td>阻塞更新PC</td>
</tr>
<tr>
<td>NPC</td>
<td>input</td>
<td>[31:0]</td>
<td>D级NPC计算出的NPC传入</td>
</tr>
<tr>
<td>F_PC</td>
<td><strong>output</strong></td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;NPC，传出至外部指令储存器</td>
</tr>
<tr>
<td>F_Ins</td>
<td><strong>input</strong></td>
<td>[31:0]</td>
<td>需要从外部指令储存器读入Ins</td>
</tr>
<tr>
<td><strong>FD寄存器</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>D_Stall</td>
<td>input</td>
<td></td>
<td>阻塞更新FD间寄存器</td>
</tr>
<tr>
<td>D_Flush</td>
<td>input</td>
<td></td>
<td>清除延迟槽信号</td>
</tr>
<tr>
<td>D_PC</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;F_PC</td>
</tr>
<tr>
<td>D_Ins</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;F_Ins</td>
</tr>
</tbody></table>
<ul>
<li>F级与指令储存的数据交换</li>
</ul>
<img src="image-20230311001208043.png" srcset="/img/loading.gif" lazyload alt="image-20230311001208043" style="zoom:67%;" />

<h4 id="2-Decode"><a href="#2-Decode" class="headerlink" title="2. Decode"></a>2. Decode</h4><ul>
<li>包括D_CU, EXT, NPC (Branch), DEReg</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>D_PC</td>
<td>input</td>
<td>[31:0]</td>
<td>PC流水</td>
</tr>
<tr>
<td>D_Ins</td>
<td>input</td>
<td>[31:0]</td>
<td>指令流水</td>
</tr>
<tr>
<td><strong>Conflict&#x2F;Forward</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Tuse_rs</td>
<td>output</td>
<td>[1:0]</td>
<td>AT算阻塞</td>
</tr>
<tr>
<td>Tuse_rt</td>
<td>output</td>
<td>[1:0]</td>
<td></td>
</tr>
<tr>
<td>D_rs</td>
<td>output</td>
<td>[4:0]</td>
<td>D级指令读寄存器的编号</td>
</tr>
<tr>
<td>D_rt</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>D_rs_data</td>
<td>output</td>
<td>[31:0]</td>
<td>D级指令读寄存器原数据</td>
</tr>
<tr>
<td>D_rt_data</td>
<td>output</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>D_rs_fw</td>
<td>input</td>
<td>[31:0]</td>
<td>D级转发后寄存器数据</td>
</tr>
<tr>
<td>D_rt_fw</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>EXT</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>imm16</td>
<td></td>
<td>[15:0]</td>
<td>EXT输入</td>
</tr>
<tr>
<td>EXTSelect</td>
<td></td>
<td></td>
<td>EXT功能选择</td>
</tr>
<tr>
<td>D_EXT_out</td>
<td></td>
<td>[31:0]</td>
<td>EXT输出</td>
</tr>
<tr>
<td><strong>NPC</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NPCSelect</td>
<td></td>
<td>[2:0]</td>
<td>下一指令地址选择</td>
</tr>
<tr>
<td>D_branchTrue</td>
<td></td>
<td></td>
<td>是否分支信号，进入流水</td>
</tr>
<tr>
<td>F_PC</td>
<td>input</td>
<td>[31:0]</td>
<td>算NPC用</td>
</tr>
<tr>
<td>NPC</td>
<td>output</td>
<td>[31:0]</td>
<td>传给F级IFU</td>
</tr>
<tr>
<td><strong>DEReg</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>E_Flush</td>
<td>input</td>
<td></td>
<td>阻塞清空DE寄存器</td>
</tr>
<tr>
<td>E_PC</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;D_PC</td>
</tr>
<tr>
<td>E_Ins</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;D_Ins</td>
</tr>
<tr>
<td>E_rs_data</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;<strong>D_rs_fw</strong></td>
</tr>
<tr>
<td>E_rt_data</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;<strong>D_rt_fw</strong></td>
</tr>
<tr>
<td>E_EXT_out</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;D_EXT_out</td>
</tr>
<tr>
<td>E_branchTrue</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;D_branchTrue</td>
</tr>
</tbody></table>
<h4 id="3-Execute"><a href="#3-Execute" class="headerlink" title="3. Execute"></a>3. Execute</h4><ul>
<li>包括E_CU, E_ALU, E_MDU, EMReg</li>
<li>需在此处多向Conflict传递MDU指令以及乘除运行信息，并向流水中传递HI, LO以便mf指令W级读取</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>E_PC</td>
<td>input</td>
<td>[31:0]</td>
<td>PC流水</td>
</tr>
<tr>
<td>E_Ins</td>
<td>input</td>
<td>[31:0]</td>
<td>指令流水</td>
</tr>
<tr>
<td><strong>Conflict&#x2F;Forward</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>E_branchTrue</td>
<td>input</td>
<td></td>
<td>是否分支信号</td>
</tr>
<tr>
<td>E_Tnew</td>
<td>output</td>
<td>[1:0]</td>
<td>AT算阻塞</td>
</tr>
<tr>
<td>E_rs</td>
<td>output</td>
<td>[4:0]</td>
<td>E级指令读寄存器的编号</td>
</tr>
<tr>
<td>E_rt</td>
<td>output</td>
<td>[4:0]</td>
<td></td>
</tr>
<tr>
<td>E_rs_data</td>
<td>output</td>
<td>[31:0]</td>
<td>E级指令读寄存器原数据</td>
</tr>
<tr>
<td>E_rt_data</td>
<td>output</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>E_GRF_WA</td>
<td>output</td>
<td>[4:0]</td>
<td>E级指令写寄存器的编号</td>
</tr>
<tr>
<td>E_rs_fw</td>
<td>input</td>
<td>[31:0]</td>
<td>E级接收转发后寄存器数据</td>
</tr>
<tr>
<td>E_rt_fw</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>GRF_WDSrc</td>
<td></td>
<td>[2:0]</td>
<td>E级指令写寄存器的数据选择</td>
</tr>
<tr>
<td>E_GRF_WD</td>
<td>output</td>
<td>[31:0]</td>
<td>E级指令写寄存器的数据</td>
</tr>
<tr>
<td><strong>ALU</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>E_EXT_out</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>ALUSrc</td>
<td></td>
<td></td>
<td>ALU_B数据源选择</td>
</tr>
<tr>
<td>ALUSelect</td>
<td></td>
<td>[3:0]</td>
<td>ALU功能选择</td>
</tr>
<tr>
<td>E_ALU_A</td>
<td></td>
<td>[31:0]</td>
<td>&#x3D;<strong>E_rs_fw</strong>：ALU_A口数据</td>
</tr>
<tr>
<td>E_ALU_B</td>
<td></td>
<td>[31:0]</td>
<td>&#x3D;<strong>E_rt_fw</strong>&#x2F;E_EXT_out：ALU_B口数据</td>
</tr>
<tr>
<td><strong>MDU</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MDU</td>
<td>output</td>
<td></td>
<td>MDU指令</td>
</tr>
<tr>
<td>MDUSelect</td>
<td></td>
<td>[2:0]</td>
<td>CU给MDU的功能选择</td>
</tr>
<tr>
<td>MDUStart</td>
<td>output</td>
<td></td>
<td>MDU运算开始</td>
</tr>
<tr>
<td>MDUBusy</td>
<td>output</td>
<td></td>
<td>MDU运算进行（发给Conflict判断阻塞)</td>
</tr>
<tr>
<td>E_HI</td>
<td></td>
<td>[31:0]</td>
<td>待转发的E级MDU的HI结果</td>
</tr>
<tr>
<td>E_LO</td>
<td></td>
<td>[31:0]</td>
<td>待转发的E级MDU的LO结果</td>
</tr>
<tr>
<td><strong>EMReg</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>M_PC</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;E_PC</td>
</tr>
<tr>
<td>M_Ins</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;E_Ins</td>
</tr>
<tr>
<td>M_ALU_Y</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;E_ALU_Y</td>
</tr>
<tr>
<td>M_rt_data</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;<strong>&#x3D;E_rt_fw</strong></td>
</tr>
<tr>
<td>M_branchTrue</td>
<td>output</td>
<td>reg</td>
<td>&lt;&#x3D;E_branchTrue</td>
</tr>
<tr>
<td>M_HI</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;E_HI</td>
</tr>
<tr>
<td>M_LO</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;E_LO</td>
</tr>
</tbody></table>
<ul>
<li>#####E_ALU</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>op</td>
<td>input</td>
<td>[3:0]</td>
<td></td>
</tr>
<tr>
<td>A</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>B</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>Y</td>
<td>output</td>
<td>[31:0]</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li><p>#####E_MDU</p>
<ul>
<li>当指令为mthi, mtlo，将寄存器数据写入HI, LO时，始终上升沿直接给HI, LO赋为A</li>
<li>当为其余四条运算指令时，设置临时计数变量cnt，初始为0，接受到Start信号时，开始设置Busy为1；根据MDU功能选择编码，分别直接计算出HI, LO对应结果赋值，因为其他乘除操作已被阻塞，不会提前读取或写入；设置cnt为5或10，每周期-1，cnt&#x3D;&#x3D;1代表运算结束，持续保持Busy为5&#x2F;10周期后将cnt, Busy归零。</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Start</td>
<td>input</td>
<td></td>
<td>CU传入开始乘除运算信号</td>
</tr>
<tr>
<td>MDUSelect</td>
<td>input</td>
<td>[2:0]</td>
<td>CU传入乘除功能选择</td>
</tr>
<tr>
<td>A</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>B</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>Busy</td>
<td>output</td>
<td>reg</td>
<td>正在运算信号</td>
</tr>
<tr>
<td>HI</td>
<td>output</td>
<td>reg [31:0]</td>
<td></td>
</tr>
<tr>
<td>LO</td>
<td>output</td>
<td>reg [31:0]</td>
<td></td>
</tr>
</tbody></table>
<h4 id="4-Memory"><a href="#4-Memory" class="headerlink" title="4. Memory"></a>4. Memory</h4><ul>
<li>包括M_CU, M_DE</li>
<li>因储存器外置，删除DM，加入对字节存取数据的操作，包括通过控制四位ByteEn各位</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>M_PC</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>M_Ins</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>Conflict&#x2F;Forward</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>M_branchTrue</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>M_Tnew</td>
<td>output</td>
<td>[1:0]</td>
<td>AT算阻塞</td>
</tr>
<tr>
<td>M_GRF_WA</td>
<td>output</td>
<td>[4:0]</td>
<td>M级指令写寄存器编号</td>
</tr>
<tr>
<td>M_GRF_WD</td>
<td>output</td>
<td>[31:0]</td>
<td>M级指令写寄存器数据</td>
</tr>
<tr>
<td>M_rt</td>
<td>output</td>
<td>[4:0]</td>
<td>M级指令读寄存器编号</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GRF_WDSrc</td>
<td></td>
<td>[2:0]</td>
<td>M级指令写寄存器数据选择</td>
</tr>
<tr>
<td>MFSelect</td>
<td></td>
<td>[1:0]</td>
<td>读HI LO功能选择</td>
</tr>
<tr>
<td>M_HI</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级MDU的HI结果</td>
</tr>
<tr>
<td>M_LO</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级MDU的LO结果</td>
</tr>
<tr>
<td>M_ALU_Y</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级ALU计算结果</td>
</tr>
<tr>
<td><strong>M_BE</strong>（ByteEnable）</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>lowAddr</td>
<td></td>
<td>[1:0]</td>
<td>&#x3D;M_ALU_Y[1:0]，DM写入地址地两位</td>
</tr>
<tr>
<td>M_rt_fw</td>
<td>input</td>
<td>[31:0]</td>
<td>M级接收转发后将写入DM的数据</td>
</tr>
<tr>
<td>ByteSelect</td>
<td></td>
<td>[1:0]</td>
<td>CU访存数据类型选择</td>
</tr>
<tr>
<td>MemWrite</td>
<td></td>
<td></td>
<td>DM写使能</td>
</tr>
<tr>
<td>ByteEn</td>
<td>output</td>
<td>reg [3:0]</td>
<td>控制每一位是否读写的信号输出</td>
</tr>
<tr>
<td>M_DM_WD</td>
<td>output</td>
<td>reg [31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>M_DE</strong>（DataExtend）</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>DESelect</td>
<td></td>
<td>[2:0]</td>
<td>字节数据拓展类型</td>
</tr>
<tr>
<td>M_DM_RDin</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>M_DM_RDout</td>
<td></td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>MWReg</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>W_PC</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_PC</td>
</tr>
<tr>
<td>W_Ins</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_Ins</td>
</tr>
<tr>
<td>W_ALU_Y</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_ALU_Y</td>
</tr>
<tr>
<td>W_DM_RD</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_DM_RDout</td>
</tr>
<tr>
<td>W_branchTrue</td>
<td>output</td>
<td>reg</td>
<td>&lt;&#x3D;M_branchTrue</td>
</tr>
<tr>
<td>W_HI</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_HI</td>
</tr>
<tr>
<td>W_LO</td>
<td>output</td>
<td>reg [31:0]</td>
<td>&lt;&#x3D;M_LO</td>
</tr>
</tbody></table>
<ul>
<li><h5 id="M-BE（计算字节访存使能，调整四字节写入数据）"><a href="#M-BE（计算字节访存使能，调整四字节写入数据）" class="headerlink" title="M_BE（计算字节访存使能，调整四字节写入数据）"></a>M_BE（计算字节访存使能，调整四字节写入数据）</h5><ul>
<li><p>合并在Memory中，在写入的条件下，根据写入数据类型和写入地址低两位产生四个字节的每一位控制信号，即四位ByteEn</p>
</li>
<li><p>后续再根据ByteEn调整将写入内存的数据，需将待写入的字节移动到对应为En1的位置</p>
</li>
</ul>
</li>
<li><h5 id="M-DE（调整内存读出数据，截取需要的字节后拓展）"><a href="#M-DE（调整内存读出数据，截取需要的字节后拓展）" class="headerlink" title="M_DE（调整内存读出数据，截取需要的字节后拓展）"></a>M_DE（调整内存读出数据，截取需要的字节后拓展）</h5><ul>
<li><p>注意DESelect种类编码，注意需要将读出字节移动至低位，高位进行拓展补齐</p>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>lowAddr</td>
<td>input</td>
<td>[1:0]</td>
<td></td>
</tr>
<tr>
<td>DESelect</td>
<td>input</td>
<td>[2:0]</td>
<td></td>
</tr>
<tr>
<td>in</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>out</td>
<td>output</td>
<td>[31:0]</td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>M级与内存数据交换</p>
</li>
<li><img src="image-20230311001314893.png" srcset="/img/loading.gif" lazyload alt="image-20230311001314893" style="zoom:67%;" /></li>
</ul>
<h4 id="5-Writeback"><a href="#5-Writeback" class="headerlink" title="5. Writeback"></a>5. Writeback</h4><ul>
<li>包括W_CU</li>
</ul>
<table>
<thead>
<tr>
<th>Port name</th>
<th>Direction</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>clk</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>reset</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>W_Ins</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td>W_PC</td>
<td>input</td>
<td>[31:0]</td>
<td></td>
</tr>
<tr>
<td><strong>Conflict&#x2F;Forward</strong></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>W_branchTrue</td>
<td>input</td>
<td></td>
<td></td>
</tr>
<tr>
<td>W_GRF_WA</td>
<td>output</td>
<td>[4:0]</td>
<td>W级指令写寄存器编号</td>
</tr>
<tr>
<td>GRF_WDSrc</td>
<td></td>
<td>[2:0]</td>
<td>W级指令写寄存器数据选择</td>
</tr>
<tr>
<td>MFSelect</td>
<td></td>
<td>[1:0]</td>
<td>读HI LO功能选择</td>
</tr>
<tr>
<td>W_ALU_Y</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级ALU计算结果</td>
</tr>
<tr>
<td>W_DM_RD</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的M级DM读出数据</td>
</tr>
<tr>
<td>W_HI</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级MDU的HI结果</td>
</tr>
<tr>
<td>W_LO</td>
<td>input</td>
<td>[31:0]</td>
<td>待转发的E级MDU的LO结果</td>
</tr>
<tr>
<td>W_GRF_WD</td>
<td>output</td>
<td>[31:0]</td>
<td>W级指令写寄存器数据</td>
</tr>
</tbody></table>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li>非中断异常测试同P6</li>
<li>中断测试</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text <br>lui $1,0xffff<br>ori $1,$1,0xfc01<br>mtc0 $1,$12<br>lui $2,0xffff<br>#int-grf<br>ori $2,$2,0x1234<br>#int-store<br>sw $2,0($0)<br>ori $3,$0,0xfc01<br>#int-mfc0<br>mtc0 $3,$12<br>#int-load<br>lw $4,0($0)<br>lw $5,0($0)<br>#int-stall<br>add $6,$5,$4<br>lui $7,0x7fff<br>lui $8,0x7fff<br>#int-beq<br>beq $7,$8,label1<br>#int&amp;exc-BD<br>add $9,$7,$8<br>#int-D beq<br>addi $10,$0,0x0001<br>addi $11,$0,0x0002<br>beq $7,$8,label1<br>nop<br><br>label1:<br>mult $7,$8<br>syscall<br>div $7,$8<br>syscall<br>mthi $7<br>syscall<br>mtlo $8<br>syscall<br>mfhi $10<br>mflo $11<br>mult $7,$8<br>beq $7,$8,label2<br>#int-many nop<br>mflo $12<br>addi $12,$0,0x0001<br>addi $12,$0,0x0002<br><br>label2:<br>addi $13,$0,0x0001<br><br>end:<br>beq $0,$0,end<br>nop<br><br><br>.ktext 0x4180<br>main_handler:<br>mfc0 $26,$13<br>mfc0 $27,$14<br>ori $27,$0,0x007c<br>and $26,$27,$26<br>beq $0,$26,interrupt<br>nop<br>mfc0 $26,$14<br>add $26,$26,4<br>mtc0 $26,$14<br>beq $0,$0,return<br>nop<br><br>interrupt:<br>ori $27,$0,0x2137<br>sw $27,0x7f20($0)<br>beq $0,$0,return<br>nop<br><br>return:<br>eret<br></code></pre></td></tr></table></figure>

<p><img src="/image-20230311001726074.png" srcset="/img/loading.gif" lazyload alt="image-20230311001726074"></p>
<ul>
<li>异常测试：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text<br>    mtc0 $0, $12<br>    ori $at, $0, 0xfffc<br><br> #====OV=====<br>    lui $t0, 0x7fff<br>    lui $t1, 0xffff<br>    add $t2, $t0, $t1<br>    sub $t2, $t0, $t1<br>    sub $t2, $t1, $t0<br>    lui $t1, 0x7fff<br>    add $t2, $t0, $t1<br>    ori $t1, $t1, 0xffff<br>    addi $t2, $t1, 0xfffffff0<br>    addi $t1, $t1, 0x0010<br><br> #=====SYSCALL=====<br>    syscall<br>    <br>    #=====ADEL=====<br>    lui $t1, 0x7fff<br>    jal label1<br>    add $ra, $ra, $t1<br>label1:<br>    jr $ra<br>    nop<br>    jal label2<br>    addi $ra, $ra, 1<br>label2:<br>    jr $ra<br>    nop<br>    ori $t0, $0, 0x7f00<br>    ori $t2, $0, 0x7f20<br>    sw $t0, 0($0)<br>    lw $t0, 0($0)<br>    lw $t0, 1($0)<br>    lw $t0, 2($0)<br>    lh $t0, 3($0)<br>    lh $t0, 0($t0)<br>    lh $t0, 2($t0)<br>    lb $t0, 0($t0)<br>    lb $t0, 3($t0)<br>loop_timer1:<br>    lw $t1, 0($t0)<br>    addi $t0, $t0, 4<br>    bne $t0, $t2, loop_timer1<br>    nop<br>    ori $t0, $0, 0x3000<br>    lw $t0, 0($t0)<br>    lui $t0, 0x7fff<br>    ori $t0, $t0, 0xffff<br> lw $t0, 1($t0)<br> lw $t0, -4($0)<br> <br> #=====ADES=====<br> sw $0, 1($0)<br>    sw $0, 2($0)<br>    sh $0, 3($0)<br>    sw $0, 4($0)<br>    sh $0, 6($0)<br>    sb $0, 7($0)<br>    ori $t0, $0, 0x7f00<br>    sh $0, 0($t0)<br>    sh $0, 2($t0)<br>    sb $0, 0($t0)<br>    sb $0, 3($t0)<br>    ori $t1, $0, 0x7f30<br>loop_timer2:<br> sw $0, 0($t0)<br> addi $t0, $t0, 4<br>    bne $t0, $t1, loop_timer2<br>    nop<br>    ori $t0, $0, 0x3000<br>    sw $0, 0($t0)<br>    lui $t0, 0x7fff<br>    ori $t0, $t0, 0xffff<br> sw $0, 1($t0)<br> sw $0, -1($0)<br><br> #=====ALTOGETHER=====<br> lui $t0, 0x7fff<br> ori $t1, $t0, 0xffff<br> sw $0, 0($t0)<br> addi $t1, $t1, 1<br> syscall<br> <br> sw $0, 0($t0)<br> addi $t1, $t1, 1<br> nop<br> <br> sw $0, 0($t0)<br> addi $t1, $t1, 0<br> syscall<br> <br> sw $0, 0($0)<br> addi $t1, $t1, 1<br> syscall<br> <br> lui $t0, 0x8000<br> addi $t1, $t1, 1<br> beq $t0, $t1, end<br> nop<br><br>end:<br>    beq $0, $0, end<br>    nop<br><br>.ktext 0x4180<br>_main_handler:<br>    mfc0 $k0, $13<br>    mfc0 $k0, $14<br>    and $k0, $k0, $at<br>    addi $k0, $k0, 4<br>    mtc0 $k0, $14<br>    eret<br><br></code></pre></td></tr></table></figure>

<p><img src="/image-20230311001804942.png" srcset="/img/loading.gif" lazyload alt="image-20230311001804942"></p>
<h2 id="掉的坑"><a href="#掉的坑" class="headerlink" title="掉的坑"></a>掉的坑</h2><ul>
<li><strong>逻辑判断式中信号不可有高阻态否则出x</strong>，删除赋值逻辑时需给0，否则删除所有位置的这个信号</li>
<li>地址异常中，合法地址包括DM，TC0，TC1以及<strong>中断发生器</strong>响应地址</li>
</ul>
<img src="image-20230311001827809.png" srcset="/img/loading.gif" lazyload alt="image-20230311001827809" style="zoom:80%;" />

<ul>
<li>注意出现异常或中断时，除了需要将所有级寄存器修改至即将跳转至handler的样貌之外，还需要将M级读写字节使能设为0000，防止后续指令的继续进行以及<strong>当前指令在M级对内存的写入</strong></li>
<li>注意eret与mtc0的写后读冲突，需要单独判断阻塞，判断方法为当D级为eret即将读CP0的EPC时，EM级如果有mtc0即将写入CP0的EPC，即rd为14时，阻塞。</li>
<li>宏观PC，与提供给CP0的VPC均为M级PC</li>
<li>timer中不可写count寄存器，并且只能用lw，sw进行读写</li>
</ul>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><ol>
<li><p>当键盘鼠标按键时，会发出一个中断信号，经过中断控制器处理传到CPU，然后CPU根据不同的中断号执行不同的中断响应程序，然后进行相应的IO操作，如把按下的按键编码读到寄存器，执行相应功能。</p>
</li>
<li><p>为了不与正常的指令范围冲突，需要在特定地址提前放置中断处理程序并且其他指令与数据不能包含这段地址范围。用户不可自定义入口地址，因为自定义的地址上的中断处理程序可能会被其他数据覆盖。并且如果由用户提供中断异常处理程序的话，跳转的地址也是计算出来的，但是如果在计算跳转地址的时候出现了错误，异常处理就无法正常进行。</p>
</li>
<li><p>CPU外设数量可能会更多，并且是变化的，不可硬性直接相连。需要添加桥，根据读写地址或者根据外设特定信号，动态选择读写外设。</p>
</li>
<li><p>idle，load，cnt状态行为相同，只有interrupt状态控制功能不同</p>
<ol>
<li><p>idle状态下，如果计数器使能为1则转至load状态</p>
</li>
<li><p>load状态下，加载初始值之后转至cnt状态</p>
</li>
<li><p>cnt状态下，如计数器使能为1则开始倒计数，cnt&#x3D;&#x3D;0之后产生一周期终端信号，状态变为interrupt；如果计数器使能为0，则回到idle</p>
</li>
<li><p>interrupt状态下</p>
<ol>
<li>如果在模式0，计数到0时计数器使能变0，持续产生中断，变为idle状态，直到en为1，中断才清零，重新倒计时</li>
<li>如果在模式1，计数为0时中断直接变0，仅持续一个周期，但en仍为1，变为idle状态后可以自动循环继续倒计时，产生周期中断脉冲</li>
</ol>
</li>
</ol>
</li>
<li><p>倘若中断信号流入的时候，在检测宏观 PC 的一级CPU 该级所有信息均为空，则无法获得当前的PC以及当前指令是否在延迟槽中，无法获得执行完中断程序后的正确返回地址。所以清空流水线时需要保留原指令的地址以及是否处于延迟槽的信号。</p>
</li>
<li><p>Register specifiers rs and rd must not be equal, because such an instruction does not have the same effect when reexecuted. The result of executing such an instruction is UNPREDICTABLE. This restriction permits an exception handler to resume execution by re-executing the branch when an exception occurs in the branch delay slot.</p>
</li>
<li><p>指令集要求。寄存器说明符 rs 和 rd 不得相等，因为此类指令在重新执行时不具有相同的效果。执行此类指令的结果是不可预测的。此限制允许异常处理程序在分支延迟槽中发生异常时通过重新执行分支来恢复执行。</p>
</li>
</ol>
<h2 id="结算页面"><a href="#结算页面" class="headerlink" title="结算页面"></a>结算页面</h2><p>计组实验结束了，当你经历过面向对，象、操作系统、编译技术等课程的洗礼，或许你又会觉得，当年的计组是那么和蔼可亲。但请相信，没有北航人跨不过的坎”我们总要背起行囊，扬起风帆，向尽头之海进发，一往无前。</p>
<p>感谢你一路以来的不离不弃，坚守相伴，这一切的洗礼才刚刚开始，长路漫漫祝你前程似锦。</p>
<p>​                                                                                                                                                      计组课程团队<br>​                                                                                                                                                               @新北5号<br>​                                                                                                                                                               2022.12.21</p>
<img src="430ce62ac2101f40f1624ec2b8a9ef6.jpg" srcset="/img/loading.gif" lazyload width="30%" />

<img src="cdf5af3d3ddb8c050cfe8e900e9345d.jpg" srcset="/img/loading.gif" lazyload width="30%" />

<p><img src="/87d0c733f6c32a8e759b783e29a9c42.jpg" srcset="/img/loading.gif" lazyload alt="87d0c733f6c32a8e759b783e29a9c42"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Computer-Orgnization/" class="category-chain-item">Computer Orgnization</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Computer-Orgnization/">#Computer Orgnization</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>P7设计文档</div>
      <div>https://steve-strange.github.io/2023/03/10/19-16-54/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Sorcerer Inferior</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/10/20-40-24/" title="lab0基础知识整理">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">lab0基础知识整理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/10/19-16-51/" title="P6设计文档">
                        <span class="hidden-mobile">P6设计文档</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
